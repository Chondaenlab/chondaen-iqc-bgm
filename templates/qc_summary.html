{% extends "base.html" %}
{% block title %}สรุปผล Chondaen IQC BGM Online{% endblock %}

{% block content %}
<h3 class="mb-3">สรุปผล Chondaen IQC BGM Online (ตามหน่วยงาน/เครื่อง + Level)</h3>

<form method="get" class="row g-2 mb-3">
  <div class="col-md-4">
    <label class="form-label">วันที่เริ่มต้น</label>
    <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
  </div>
  <div class="col-md-4">
    <label class="form-label">วันที่สิ้นสุด</label>
    <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
  </div>
  <div class="col-md-4 d-flex align-items-end">
    <button type="submit" class="btn btn-primary me-2">กรองวันที่</button>
    <a href="{{ url_for('qc_summary') }}" class="btn btn-outline-secondary me-2">ล้างตัวกรอง</a>
    <a
      class="btn btn-success"
      href="{{ url_for('qc_summary_export', start_date=start_date, end_date=end_date) }}"
    >
      ดาวน์โหลด Excel
    </a>
  </div>
</form>

<div class="card">
  <div class="card-body p-0">
    {% if summary %}
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>หน่วยงาน/เครื่อง</th>
            <th>Level</th>
            <th>n</th>
            <th>Mean</th>
            <th>SD</th>
            <th>Min</th>
            <th>Max</th>
            <th>Ref (min-max)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in summary %}
          <tr>
            <td>{{ row.test_name }}</td>
            <td>{{ row.level }}</td>
            <td>{{ row.n }}</td>
            <td>{{ "%.3f"|format(row.mean) }}</td>
            <td>{{ "%.3f"|format(row.sd) }}</td>
            <td>{{ "%.3f"|format(row.min) }}</td>
            <td>{{ "%.3f"|format(row.max) }}</td>
            <td>
              {% if row.ref_min is not none and row.ref_max is not none %}
                {{ "%.3f"|format(row.ref_min) }} - {{ "%.3f"|format(row.ref_max) }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="p-3 mb-0 text-muted">
        ยังไม่มีข้อมูลสำหรับช่วงวันที่ที่เลือก หรือยังไม่ได้บันทึกผล QC
      </p>
    {% endif %}
  </div>
</div>
{% endblock %}
